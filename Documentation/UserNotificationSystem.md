# User Notification System

**Version:** 1.0
**Date:** 2024-05-28

## 1. Overview

The User Notification System is designed to inform users about important events, actions, and updates within the platform. This includes system messages, content moderation actions, and potentially other relevant activities in the future. The goal is to provide timely and relevant information to enhance user engagement and awareness.

## 2. Key Components

### 2.1. Database Schema

#### 2.1.1. `user_notifications` Table
This table stores individual notifications for each user.
*   **Key Columns:**
    *   `id` (UUID, PK): Unique identifier for the notification.
    *   `user_id` (UUID, FK to `public.profiles`): The recipient of the notification.
    *   `notification_type` (`public.notification_type_enum`): Category of the notification.
    *   `title` (TEXT): A short title for the notification.
    *   `message` (TEXT): The main content of the notification.
    *   `link_to` (TEXT, nullable): A URL path for a call to action (e.g., view a post, go to settings).
    *   `is_read` (BOOLEAN, default `false`): Status indicating if the user has seen the notification.
    *   `created_at` (TIMESTAMPTZ): When the notification was generated.
    *   `updated_at` (TIMESTAMPTZ): When the notification was last updated (e.g., marked as read).
*   **RLS Policies:** Users can only access and update the `is_read` status of their own notifications. Inserts are handled by system processes or specific RPCs.
*   For detailed schema, refer to `DatabaseMigrations.md` (migration `20250526000003_create_user_notifications_table.sql`).

#### 2.1.2. `notification_type_enum`
This ENUM categorizes notifications.
*   **Current Values:**
    *   `system_alert`: General system announcements or alerts.
    *   `content_moderation`: Notifications related to content moderation actions (e.g., warnings, content removals).
    *   `new_message_summary`: (Future Use) For summarizing new direct messages.
    *   `connection_request`: (Future Use) For new connection requests.
    *   `rfq_update`: (Future Use) For updates related to RFQs.
    *   `default`: A generic default type.

### 2.2. RPC Functions

The following PostgreSQL functions are used to manage notifications:

*   `public.get_user_notifications(p_limit INT, p_page_number INT)`: Retrieves a paginated list of notifications for the calling user, including a total unread count.
*   `public.mark_notification_as_read(p_notification_id UUID)`: Marks a specific notification as read for the calling user. Returns the updated notification.
*   `public.mark_all_notifications_as_read()`: Marks all unread notifications as read for the calling user. Returns `true` if any notifications were updated.

These are detailed in `DatabaseMigrations.md` (migration `20250526000004_create_notification_rpcs.sql`).

### 2.3. Realtime Functionality

The system leverages Supabase Realtime. The `user_notifications` table is configured for Realtime, enabling client-side components like `NotificationBell.tsx` to receive live updates when new notifications are created or existing ones are marked as read. This allows the unread count and notification list to update dynamically.

## 3. Frontend Integration

*   **`NotificationBell.tsx`**: A component in the site header that displays a bell icon and a badge with the count of unread notifications. It fetches the initial count and listens for Realtime updates. Clicking the bell toggles the `NotificationDropdown.tsx`.
*   **`NotificationDropdown.tsx`**: A dropdown panel listing recent notifications. It allows users to:
    *   View notification details (title, message, timestamp, type).
    *   Navigate to related content via `link_to` if provided.
    *   Mark individual notifications as read (optimistically updates UI and calls RPC).
    *   Mark all notifications as read.
    *   Expand notifications to read longer messages.

## 4. How Notifications are Generated

Currently, notifications are generated by:

*   **Admin Moderation Actions (via RPCs):**
    *   `public.admin_remove_post`: When an admin removes a user's post, a `content_moderation` notification is sent to the post author.
    *   `public.admin_warn_user`: When an admin warns a user, a `content_moderation` notification is sent to the warned user.
    *   These RPCs insert records directly into the `user_notifications` table.

*   **Future Enhancements (Examples based on `notification_type_enum`):**
    *   `system_alert`: For platform-wide announcements.
    *   `new_message_summary`: Summaries of unread direct messages.
    *   `connection_request`: Alerts for new connection/friend requests.
    *   `rfq_update`: Notifications about relevant RFQ activity.
    *   Social interactions like new followers, likes on posts, comments on user's content.

## 5. Security Considerations

*   RLS policies on `user_notifications` ensure users can only access their own data.
*   RPC functions (`get_user_notifications`, `mark_notification_as_read`, `mark_all_notifications_as_read`) operate under `SECURITY INVOKER` context, ensuring they respect user permissions.
*   Notification-creating RPCs (like `admin_remove_post`) operate as `SECURITY DEFINER` to perform privileged insertions into `user_notifications` on behalf of the system or an admin. 